Repository: plone.subrequest


Branch: refs/heads/master
Date: 2018-01-28T17:03:27+01:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/plone.subrequest/commit/775bff657b1057b16103f5ec8f6eb9e59f0fb766

Prepare for Python 2 / 3 compatibility

Files changed:
M CHANGES.rst
M plone/subrequest/__init__.py
M plone/subrequest/subresponse.py
M setup.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 7496a03..28fb872 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -14,7 +14,8 @@ New features:
 
 Bug fixes:
 
-- *add item here*
+- Add Python 2 / 3 compatibility
+  [pbauer]
 
 
 1.8.4 (2017-09-06)
diff --git a/plone/subrequest/__init__.py b/plone/subrequest/__init__.py
index 02be088..9d75fab 100644
--- a/plone/subrequest/__init__.py
+++ b/plone/subrequest/__init__.py
@@ -3,14 +3,14 @@
 from AccessControl import Unauthorized
 from AccessControl.SecurityManagement import setSecurityManager
 from Acquisition import aq_base
-from cStringIO import StringIO
 from logging import getLogger
 from plone.subrequest.interfaces import ISubRequest
 from plone.subrequest.subresponse import SubResponse
 from posixpath import normpath
-from urllib import unquote  # Python2.4 does not have urlparse.unquote
-from urlparse import urljoin
-from urlparse import urlsplit
+from six.moves import cStringIO as StringIO
+from six.moves.urllib.parse import unquote
+from six.moves.urllib.parse import urljoin
+from six.moves.urllib.parse import urlsplit
 from zope.component import queryMultiAdapter
 from zope.globalrequest import getRequest
 from zope.globalrequest import setRequest
@@ -23,6 +23,7 @@
 from ZPublisher.Publish import missing_name
 
 import re
+import six
 
 
 try:
@@ -72,7 +73,7 @@ class IDisableCSRFProtection(Interface):
 
 def subrequest(url, root=None, stdout=None, exception_handler=None):
     assert url is not None, 'You must pass a url'
-    if isinstance(url, unicode):
+    if isinstance(url, six.text_type):
         url = url.encode('utf-8')
     _, _, path, query, _ = urlsplit(url)
     parent_request = getRequest()
@@ -103,7 +104,7 @@ def subrequest(url, root=None, stdout=None, exception_handler=None):
     else:
         try:
             parent_url = parent_request['URL']
-            if isinstance(parent_url, unicode):
+            if isinstance(parent_url, six.text_type):
                 parent_url = parent_url.encode('utf-8')
             # extra is the hidden part of the url, e.g. a default view
             extra = unquote(parent_url[len(parent_request['ACTUAL_URL']):])
@@ -158,7 +159,7 @@ def subrequest(url, root=None, stdout=None, exception_handler=None):
                 response.setBody(result)
             for key, value in request.response.cookies.items():
                 parent_request.response.cookies[key] = value
-        except Exception, e:
+        except Exception as e:
             logger.exception('Error handling subrequest to {0}'.format(url))
             if exception_handler is not None:
                 exception_handler(response, e)
diff --git a/plone/subrequest/subresponse.py b/plone/subrequest/subresponse.py
index 83b2daa..abb1b2f 100644
--- a/plone/subrequest/subresponse.py
+++ b/plone/subrequest/subresponse.py
@@ -27,7 +27,7 @@ def setBody(self, body, title='', is_error=0, **kw):
             return
         try:
             while True:
-                chunk = body.next()
+                chunk = next(body)
                 self.write(chunk)
         except StopIteration:
             pass
diff --git a/setup.py b/setup.py
index a8d5474..2d9dd3b 100644
--- a/setup.py
+++ b/setup.py
@@ -44,6 +44,7 @@
         # 'Acquisition',
         'five.globalrequest',
         'setuptools',
+        'six',
         'zope.globalrequest',
         ],
     extras_require={



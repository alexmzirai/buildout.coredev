Repository: plone.app.versioningbehavior


Branch: refs/heads/master
Date: 2018-01-26T07:32:20+01:00
Author: Alessandro Pisa (ale-rt) <alessandro.pisa@gmail.com>
Commit: https://github.com/plone/plone.app.versioningbehavior/commit/d2f5a6974a767a60dc612e6cc3abb9f1999ba35c

Python3 compatibility

Files changed:
M CHANGES.rst
M plone/app/versioningbehavior/browser.py
M plone/app/versioningbehavior/modifiers.py
M plone/app/versioningbehavior/tests/test_modifiers.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 0376d52..97c4e7b 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -14,7 +14,8 @@ New features:
 
 Bug fixes:
 
-- *add item here*
+- Imports are Python3 compatible
+  [ale-rt, robbuh]
 
 
 1.3.1 (2017-06-06)
diff --git a/plone/app/versioningbehavior/browser.py b/plone/app/versioningbehavior/browser.py
index 1edf23c..1c9d952 100644
--- a/plone/app/versioningbehavior/browser.py
+++ b/plone/app/versioningbehavior/browser.py
@@ -1,11 +1,12 @@
 # -*- coding: utf-8 -*-
 from plone.namedfile.utils import set_headers, stream_data
+from plone.rfc822.interfaces import IPrimaryFieldInfo
 from Products.CMFCore.utils import getToolByName
+from six.moves.urllib.parse import urlencode
 from zope.component import getMultiAdapter
 from zope.publisher.interfaces import NotFound
+
 import re
-from plone.rfc822.interfaces import IPrimaryFieldInfo
-from urllib import urlencode
 
 
 class VersionView(object):
diff --git a/plone/app/versioningbehavior/modifiers.py b/plone/app/versioningbehavior/modifiers.py
index 1b18fd0..ba1ae02 100644
--- a/plone/app/versioningbehavior/modifiers.py
+++ b/plone/app/versioningbehavior/modifiers.py
@@ -1,7 +1,6 @@
 # -*- coding: utf-8 -*-
 from Acquisition import aq_base
 from App.class_init import InitializeClass
-from itertools import izip
 from plone.dexterity.utils import iterSchemata, resolveDottedName
 from plone.dexterity.interfaces import IDexterityContent
 from plone.namedfile.interfaces import INamedBlobFileField
@@ -19,6 +18,7 @@
 from z3c.relationfield.interfaces import IRelationChoice, IRelationList
 
 import os
+import six
 
 
 manage_CloneNamedFileBlobsAddForm =  \
@@ -141,8 +141,8 @@ def getReferencedAttributes(self, obj):
                             if (os.fstat(prior_file.fileno()).st_size ==
                                     os.fstat(blob_file.fileno()).st_size):
                                 # Files are the same size, compare line by line
-                                for line, prior_line in izip(blob_file,
-                                                             prior_file):
+                                for line, prior_line in six.moves.zip(
+                                        blob_file, prior_file):
                                     if line != prior_line:
                                         break
                                 else:
@@ -166,7 +166,7 @@ def getReferencedAttributes(self, obj):
 
     def reattachReferencedAttributes(self, obj, attrs_dict):
         obj = aq_base(obj)
-        for name, blob in attrs_dict.iteritems():
+        for name, blob in six.iteritems(attrs_dict):
             iface = resolveDottedName('.'.join(name.split('.')[:-1]))
             fname = name.split('.')[-1]
             field = iface.get(fname)
@@ -184,6 +184,7 @@ def getOnCloneModifiers(self, obj):
 
         return persistent_id, persistent_load, [], []
 
+
 InitializeClass(CloneNamedFileBlobs)
 
 
@@ -226,6 +227,7 @@ def afterRetrieveModifier(self, obj, repo_clone, preserve=()):
                                   field.query(field.interface(obj)))
         return [], [], {}
 
+
 InitializeClass(SkipRelations)
 
 
diff --git a/plone/app/versioningbehavior/tests/test_modifiers.py b/plone/app/versioningbehavior/tests/test_modifiers.py
index 3c25525..34e3079 100644
--- a/plone/app/versioningbehavior/tests/test_modifiers.py
+++ b/plone/app/versioningbehavior/tests/test_modifiers.py
@@ -2,27 +2,33 @@
 from five.intid import site
 from plone.app.versioningbehavior.modifiers import CloneNamedFileBlobs
 from plone.app.versioningbehavior.modifiers import SkipRelations
+from plone.app.versioningbehavior.testing import VERSIONING_INTEGRATION_TESTING
 from plone.autoform.interfaces import IFormFieldProvider
 from plone.dexterity.fti import DexterityFTI
-from plone.dexterity.utils import createContentInContainer, createContent
+from plone.dexterity.utils import createContent
+from plone.dexterity.utils import createContentInContainer
 from plone.namedfile import field
 from plone.namedfile.file import NamedBlobFile
 from plone.supermodel import model
 from Products.CMFEditions.tests.base import CMFEditionsBaseTestCase
-from StringIO import StringIO
-from unittest import TestSuite, makeSuite
+from six import StringIO
+from unittest import makeSuite
+from unittest import TestSuite
 from z3c.relationfield.relation import RelationValue
-from z3c.relationfield.schema import RelationChoice, RelationList
+from z3c.relationfield.schema import RelationChoice
+from z3c.relationfield.schema import RelationList
 from ZODB.interfaces import IBlob
 from zope.app.intid.interfaces import IIntIds
 from zope.component import getUtility
 from zope.configuration import xmlconfig
-from zope.interface import alsoProvides, Interface
-from ..testing import VERSIONING_INTEGRATION_TESTING
+from zope.interface import alsoProvides
+from zope.interface import Interface
 
 
 class IBlobFile(model.Schema):
-        file = field.NamedBlobFile(title=u'File')
+    file = field.NamedBlobFile(title=u'File')
+
+
 alsoProvides(IBlobFile, IFormFieldProvider)
 
 
@@ -38,6 +44,8 @@ class IRelationsBehavior(model.Schema):
                             required=False, values=[])
     multiple = RelationList(title=u'Multiple (Relations field)',
                             required=False)
+
+
 alsoProvides(IRelationsBehavior, IFormFieldProvider)
 
 
@@ -73,7 +81,7 @@ def testCloneNamedFileBlobsInSchema(self):
         self.assertTrue(
             'plone.dexterity.schema.generated.plone_0_BlobFile.file'
             in attrs_dict)
-        blob = attrs_dict.values()[0]
+        blob = list(attrs_dict.values())[0]
         self.assertTrue(IBlob.providedBy(blob))
 
         file2 = createContentInContainer(self.portal, 'BlobFile')
@@ -114,7 +122,7 @@ def testCloneNamedFileBlobsInBehavior(self):
         self.assertTrue(
             'plone.app.versioningbehavior.tests.test_modifiers.IBlobFile.file'
             in attrs_dict)
-        blob = attrs_dict.values()[0]
+        blob = list(attrs_dict.values())[0]
         self.assertTrue(IBlob.providedBy(blob))
 
         file2 = createContentInContainer(self.portal, 'BlobFile')
@@ -182,7 +190,7 @@ def testCloneNamedFileBlobsWithNoFile(self):
         self.assertTrue(
             'plone.dexterity.schema.generated.plone_0_BlobFile.file'
             in attrs_dict)
-        blob = attrs_dict.values()[0]
+        blob = list(attrs_dict.values())[0]
         self.assertTrue(IBlob.providedBy(blob))
         on_clone_modifiers = modifier.getOnCloneModifiers(file1)
         pers_id, pers_load, empty1, empty2 = on_clone_modifiers



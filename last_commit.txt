Repository: Products.Marshall


Branch: refs/heads/master
Date: 2018-01-31T00:56:00+01:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/Products.Marshall/commit/4af84f27f59607386fba893f9dd007ab616d455c

Replaced Extensions/Install.py with GenericSetup profile.

Files changed:
A Products/Marshall/profiles/default/metadata.xml
A Products/Marshall/profiles/uninstall/metadata.xml
M CHANGES.rst
M Products/Marshall/__init__.py
M Products/Marshall/configure.zcml
M Products/Marshall/profile.py
D Products/Marshall/Extensions/Install.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 0f36358..32be17d 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -10,7 +10,7 @@ Breaking changes:
 
 New features:
 
-- *add item here*
+- Replaced Extensions/Install.py with GenericSetup profile.  [maurits]
 
 Bug fixes:
 
diff --git a/Products/Marshall/Extensions/Install.py b/Products/Marshall/Extensions/Install.py
deleted file mode 100644
index e442505..0000000
--- a/Products/Marshall/Extensions/Install.py
+++ /dev/null
@@ -1,25 +0,0 @@
-# -*- coding: utf-8 -*-
-from Products.CMFCore.utils import getToolByName
-from Products.Marshall import registry
-from Products.Marshall.config import TOOL_ID as tool_id
-from six.moves import cStringIO as StringIO
-
-add_registry = registry.manage_addRegistry
-
-
-def install_tool(self, out):
-    tool = getToolByName(self, tool_id, None)
-    if tool is not None:
-        out.write('Registry was already installed.\n')
-        return
-    add_registry(self)
-    out.write('Registry installed sucessfully.\n')
-
-
-def install(self, out=None):
-    if out is None:
-        out = StringIO()
-
-    install_tool(self, out)
-
-    return out.getvalue()
diff --git a/Products/Marshall/__init__.py b/Products/Marshall/__init__.py
index 5de943f..6fcee94 100644
--- a/Products/Marshall/__init__.py
+++ b/Products/Marshall/__init__.py
@@ -21,10 +21,6 @@
 
 import pkg_resources
 
-# Kick off Extensions.Install import
-from Products.Marshall.Extensions import Install
-del Install
-
 # Kick off handler registration
 from Products.Marshall import handlers
 
diff --git a/Products/Marshall/configure.zcml b/Products/Marshall/configure.zcml
index 3761fac..fd5a493 100644
--- a/Products/Marshall/configure.zcml
+++ b/Products/Marshall/configure.zcml
@@ -1,5 +1,6 @@
 <configure
-  xmlns="http://namespaces.zope.org/zope">
+  xmlns="http://namespaces.zope.org/zope"
+  xmlns:genericsetup="http://namespaces.zope.org/genericsetup">
 
   <adapter
       factory=".profile.MarshallRegistryFileExportImportAdapter"
@@ -13,5 +14,21 @@
       for=".interfaces.IMarshallRegistry"
       />
 
-</configure>
+  <genericsetup:registerProfile
+      name="default"
+      title="Marshaller"
+      directory="profiles/default"
+      description="Products.Marshall"
+      provides="Products.GenericSetup.interfaces.EXTENSION"
+      post_handler=".profile.install_tool"
+      />
 
+  <genericsetup:registerProfile
+      name="uninstall"
+      title="Uninstall Marshaller"
+      directory="profiles/uninstall"
+      provides="Products.GenericSetup.interfaces.EXTENSION"
+      post_handler=".profile.uninstall_tool"
+      />
+
+</configure>
diff --git a/Products/Marshall/profile.py b/Products/Marshall/profile.py
index 4140be0..cf0c6f7 100644
--- a/Products/Marshall/profile.py
+++ b/Products/Marshall/profile.py
@@ -1,3 +1,4 @@
+# -*- coding: utf-8 -*-
 # Marshall: A framework for pluggable marshalling policies
 # Copyright (C) 2004-2006 Enfold Systems, LLC
 #
@@ -15,22 +16,24 @@
 # along with this program; if not, write to the Free Software
 # Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
 #
-"""
-"""
-
-from zope.interface import implementer
 
+from Products.CMFCore.utils import getToolByName
 from Products.GenericSetup.interfaces import IFilesystemExporter
 from Products.GenericSetup.interfaces import IFilesystemImporter
+from Products.GenericSetup.utils import DEFAULT
 from Products.GenericSetup.utils import ExportConfiguratorBase
 from Products.GenericSetup.utils import ImportConfiguratorBase
-from Products.GenericSetup.utils import DEFAULT
 from Products.GenericSetup.utils import KEY
-from Products.PageTemplates.PageTemplateFile import PageTemplateFile
-
+from Products.Marshall import registry
 from Products.Marshall.config import TOOL_ID
 from Products.Marshall.registry import createPredicate
+from Products.PageTemplates.PageTemplateFile import PageTemplateFile
+from zope.interface import implementer
+
+import logging
 
+
+logger = logging.getLogger('Products.Marshall')
 _FILENAME = 'marshall-registry.xml'
 
 
@@ -184,3 +187,23 @@ def import_(self, import_context, subdir, root=False):
                                 'no %s in %s' % (_FILENAME, subdir))
         else:
             pass
+
+
+def install_tool(context):
+    tool = getToolByName(context, TOOL_ID, None)
+    if tool is not None:
+        logger.info('Registry was already installed.')
+        return
+    portal = getToolByName(context, 'portal_url').getPortalObject()
+    registry.manage_addRegistry(portal)
+    logger.info('Registry installed sucessfully.')
+
+
+def uninstall_tool(context):
+    tool = getToolByName(context, TOOL_ID, None)
+    if tool is None:
+        logger.info('Registry was already uninstalled.')
+        return
+    portal = getToolByName(context, 'portal_url').getPortalObject()
+    portal.manage_delObjects([TOOL_ID])
+    logger.info('Registry uninstalled sucessfully.')
diff --git a/Products/Marshall/profiles/default/metadata.xml b/Products/Marshall/profiles/default/metadata.xml
new file mode 100644
index 0000000..b22370d
--- /dev/null
+++ b/Products/Marshall/profiles/default/metadata.xml
@@ -0,0 +1,4 @@
+<?xml version="1.0"?>
+<metadata>
+  <version>1000</version>
+</metadata>
diff --git a/Products/Marshall/profiles/uninstall/metadata.xml b/Products/Marshall/profiles/uninstall/metadata.xml
new file mode 100644
index 0000000..b22370d
--- /dev/null
+++ b/Products/Marshall/profiles/uninstall/metadata.xml
@@ -0,0 +1,4 @@
+<?xml version="1.0"?>
+<metadata>
+  <version>1000</version>
+</metadata>


Repository: Products.Marshall


Branch: refs/heads/master
Date: 2018-02-01T13:25:41+01:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/Products.Marshall/commit/2e0557f85a945b06f7c9d3190afbbb2266a5c196

Merge pull request #6 from plone/profile

Replaced Extensions/Install.py with GenericSetup profile.

Files changed:
A Products/Marshall/profiles/default/metadata.xml
A Products/Marshall/profiles/uninstall/metadata.xml
M CHANGES.rst
M Products/Marshall/__init__.py
M Products/Marshall/configure.zcml
M Products/Marshall/profile.py
D Products/Marshall/Extensions/Install.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 0f36358..32be17d 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -10,7 +10,7 @@ Breaking changes:
 
 New features:
 
-- *add item here*
+- Replaced Extensions/Install.py with GenericSetup profile.  [maurits]
 
 Bug fixes:
 
diff --git a/Products/Marshall/Extensions/Install.py b/Products/Marshall/Extensions/Install.py
deleted file mode 100644
index e442505..0000000
--- a/Products/Marshall/Extensions/Install.py
+++ /dev/null
@@ -1,25 +0,0 @@
-# -*- coding: utf-8 -*-
-from Products.CMFCore.utils import getToolByName
-from Products.Marshall import registry
-from Products.Marshall.config import TOOL_ID as tool_id
-from six.moves import cStringIO as StringIO
-
-add_registry = registry.manage_addRegistry
-
-
-def install_tool(self, out):
-    tool = getToolByName(self, tool_id, None)
-    if tool is not None:
-        out.write('Registry was already installed.\n')
-        return
-    add_registry(self)
-    out.write('Registry installed sucessfully.\n')
-
-
-def install(self, out=None):
-    if out is None:
-        out = StringIO()
-
-    install_tool(self, out)
-
-    return out.getvalue()
diff --git a/Products/Marshall/__init__.py b/Products/Marshall/__init__.py
index 5de943f..6fcee94 100644
--- a/Products/Marshall/__init__.py
+++ b/Products/Marshall/__init__.py
@@ -21,10 +21,6 @@
 
 import pkg_resources
 
-# Kick off Extensions.Install import
-from Products.Marshall.Extensions import Install
-del Install
-
 # Kick off handler registration
 from Products.Marshall import handlers
 
diff --git a/Products/Marshall/configure.zcml b/Products/Marshall/configure.zcml
index 3761fac..fd5a493 100644
--- a/Products/Marshall/configure.zcml
+++ b/Products/Marshall/configure.zcml
@@ -1,5 +1,6 @@
 <configure
-  xmlns="http://namespaces.zope.org/zope">
+  xmlns="http://namespaces.zope.org/zope"
+  xmlns:genericsetup="http://namespaces.zope.org/genericsetup">
 
   <adapter
       factory=".profile.MarshallRegistryFileExportImportAdapter"
@@ -13,5 +14,21 @@
       for=".interfaces.IMarshallRegistry"
       />
 
-</configure>
+  <genericsetup:registerProfile
+      name="default"
+      title="Marshaller"
+      directory="profiles/default"
+      description="Products.Marshall"
+      provides="Products.GenericSetup.interfaces.EXTENSION"
+      post_handler=".profile.install_tool"
+      />
 
+  <genericsetup:registerProfile
+      name="uninstall"
+      title="Uninstall Marshaller"
+      directory="profiles/uninstall"
+      provides="Products.GenericSetup.interfaces.EXTENSION"
+      post_handler=".profile.uninstall_tool"
+      />
+
+</configure>
diff --git a/Products/Marshall/profile.py b/Products/Marshall/profile.py
index 4140be0..cf0c6f7 100644
--- a/Products/Marshall/profile.py
+++ b/Products/Marshall/profile.py
@@ -1,3 +1,4 @@
+# -*- coding: utf-8 -*-
 # Marshall: A framework for pluggable marshalling policies
 # Copyright (C) 2004-2006 Enfold Systems, LLC
 #
@@ -15,22 +16,24 @@
 # along with this program; if not, write to the Free Software
 # Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
 #
-"""
-"""
-
-from zope.interface import implementer
 
+from Products.CMFCore.utils import getToolByName
 from Products.GenericSetup.interfaces import IFilesystemExporter
 from Products.GenericSetup.interfaces import IFilesystemImporter
+from Products.GenericSetup.utils import DEFAULT
 from Products.GenericSetup.utils import ExportConfiguratorBase
 from Products.GenericSetup.utils import ImportConfiguratorBase
-from Products.GenericSetup.utils import DEFAULT
 from Products.GenericSetup.utils import KEY
-from Products.PageTemplates.PageTemplateFile import PageTemplateFile
-
+from Products.Marshall import registry
 from Products.Marshall.config import TOOL_ID
 from Products.Marshall.registry import createPredicate
+from Products.PageTemplates.PageTemplateFile import PageTemplateFile
+from zope.interface import implementer
+
+import logging
 
+
+logger = logging.getLogger('Products.Marshall')
 _FILENAME = 'marshall-registry.xml'
 
 
@@ -184,3 +187,23 @@ def import_(self, import_context, subdir, root=False):
                                 'no %s in %s' % (_FILENAME, subdir))
         else:
             pass
+
+
+def install_tool(context):
+    tool = getToolByName(context, TOOL_ID, None)
+    if tool is not None:
+        logger.info('Registry was already installed.')
+        return
+    portal = getToolByName(context, 'portal_url').getPortalObject()
+    registry.manage_addRegistry(portal)
+    logger.info('Registry installed sucessfully.')
+
+
+def uninstall_tool(context):
+    tool = getToolByName(context, TOOL_ID, None)
+    if tool is None:
+        logger.info('Registry was already uninstalled.')
+        return
+    portal = getToolByName(context, 'portal_url').getPortalObject()
+    portal.manage_delObjects([TOOL_ID])
+    logger.info('Registry uninstalled sucessfully.')
diff --git a/Products/Marshall/profiles/default/metadata.xml b/Products/Marshall/profiles/default/metadata.xml
new file mode 100644
index 0000000..b22370d
--- /dev/null
+++ b/Products/Marshall/profiles/default/metadata.xml
@@ -0,0 +1,4 @@
+<?xml version="1.0"?>
+<metadata>
+  <version>1000</version>
+</metadata>
diff --git a/Products/Marshall/profiles/uninstall/metadata.xml b/Products/Marshall/profiles/uninstall/metadata.xml
new file mode 100644
index 0000000..b22370d
--- /dev/null
+++ b/Products/Marshall/profiles/uninstall/metadata.xml
@@ -0,0 +1,4 @@
+<?xml version="1.0"?>
+<metadata>
+  <version>1000</version>
+</metadata>



Repository: Products.Archetypes


Branch: refs/heads/master
Date: 2018-01-28T13:26:10+01:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/Products.Archetypes/commit/1750b2d24c0908292a015bdd5851972f376d2365

Removed CMFQuickInstaller dependency.

This was only used in ancient migration code.
Updated that code to use get_installer.

Files changed:
M CHANGES.rst
M Products/Archetypes/Extensions/migrations.py
M Products/Archetypes/Extensions/utils.py
M Products/Archetypes/configure.zcml
M setup.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 31c9dbda..6f38181e 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -10,7 +10,9 @@ Breaking changes:
 
 New features:
 
-- *add item here*
+- Removed CMFQuickInstaller dependency.
+  This was only used in ancient migration code.
+  [maurits]
 
 Bug fixes:
 
diff --git a/Products/Archetypes/Extensions/migrations.py b/Products/Archetypes/Extensions/migrations.py
index 942dba13..66d39a7b 100644
--- a/Products/Archetypes/Extensions/migrations.py
+++ b/Products/Archetypes/Extensions/migrations.py
@@ -31,16 +31,19 @@ def write(self, s):
 def reinstallArchetypes(portal, out):
     """let's quickinstaller (re)install Archetypes and it's dependencies
     """
-    qi = getToolByName(portal, 'portal_quickinstaller')
+    # Import here so it does not break when you manage to
+    # get a too old CMFPlone with a too new Archetypes.
+    from Products.CMFPlone.utils import get_installer
+    qi = get_installer(portal)
     products = ('MimetypesRegistry', 'PortalTransforms', 'Archetypes', )
     print >>out, 'Reinstalling Archetypes and it\'s dependencies'
     for product in products:
-        if qi.isProductInstalled(product):
-            qi.reinstallProducts([product])
-            print >>out, '... reinstalling %s' % product
-        else:
-            qi.installProducts([product])
-            print >>out, '... installing %s' % product
+        full_product = 'Products.{0}'.format(product)
+        if qi.is_product_installed(full_product):
+            qi.uninstall_product(full_product)
+            print >>out, '... uninstalling %s' % full_product
+        qi.install_product(full_product)
+        print >>out, '... installing %s' % full_product
     print >>out, 'Done\n'
 
 
diff --git a/Products/Archetypes/Extensions/utils.py b/Products/Archetypes/Extensions/utils.py
index c969f324..007f89df 100644
--- a/Products/Archetypes/Extensions/utils.py
+++ b/Products/Archetypes/Extensions/utils.py
@@ -306,19 +306,22 @@ def setupEnvironment(self, out, types,
                      install_deps=1):
 
     if install_deps:
-        qi = getToolByName(self, 'portal_quickinstaller', None)
         if require_dependencies:
-            if not qi.isProductInstalled('CMFFormController'):
-                qi.installProduct('CMFFormController', locked=1)
+            # Import here so it does not break when you manage to
+            # get a too old CMFPlone with a too new Archetypes.
+            from Products.CMFPlone.utils import get_installer
+            qi = get_installer(self)
+            if not qi.is_product_installed('Products.CMFFormController'):
+                qi.install_product('Products.CMFFormController', locked=1)
                 print >>out, 'Installing CMFFormController'
-            if not qi.isProductInstalled('MimetypesRegistry'):
-                qi.installProduct('MimetypesRegistry')
+            if not qi.is_product_installed('Products.MimetypesRegistry'):
+                qi.install_product('Products.MimetypesRegistry')
                 print >>out, 'Installing MimetypesRegistry'
-            if not qi.isProductInstalled('PortalTransforms'):
-                qi.installProduct('PortalTransforms')
+            if not qi.is_product_installed('Products.PortalTransforms'):
+                qi.install_product('Products.PortalTransforms')
                 print >>out, 'Installing PortalTransforms'
-            if not qi.isProductInstalled('Archetypes'):
-                qi.installProduct('Archetypes')
+            if not qi.is_product_installed('Archetypes'):
+                qi.install_product('Products.Archetypes')
                 print >>out, 'Installing Archetypes'
 
     if product_skins_dir:
diff --git a/Products/Archetypes/configure.zcml b/Products/Archetypes/configure.zcml
index 2be78b9d..4efd0742 100644
--- a/Products/Archetypes/configure.zcml
+++ b/Products/Archetypes/configure.zcml
@@ -13,7 +13,6 @@
   <include package="plone.uuid" />
 
   <include package="Products.CMFFormController" />
-  <include package="Products.CMFQuickInstallerTool" />
   <include package="Products.MimetypesRegistry" />
   <include package="Products.PortalTransforms" />
   <include package="Products.statusmessages" />
diff --git a/setup.py b/setup.py
index 55d61311..4e84ba39 100644
--- a/setup.py
+++ b/setup.py
@@ -53,7 +53,6 @@
           'zope.viewlet',
           'Products.CMFCore',
           'Products.CMFFormController',
-          'Products.CMFQuickInstallerTool',
           'Products.DCWorkflow',
           'Products.GenericSetup>=1.8.3',
           'Products.MimetypesRegistry>=2.0.3',


Repository: Products.Archetypes


Branch: refs/heads/master
Date: 2018-01-28T21:23:23+01:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/Products.Archetypes/commit/32161dabc5e23c21b3911664cbfc4dffd43976ab

Buildout: use https pypi. Remove mr.developer.

No checkout of plone.app.widgets should be needed anymore.

Files changed:
M buildout.cfg

diff --git a/buildout.cfg b/buildout.cfg
index 79fbe418..b48d77c6 100644
--- a/buildout.cfg
+++ b/buildout.cfg
@@ -1,16 +1,11 @@
 [buildout]
+index = https://pypi.python.org/simple/
 develop = .
 parts = test
 extends = http://dist.plone.org/release/5.1-latest/versions.cfg
-          https://raw.githubusercontent.com/plone/buildout.coredev/5.1/sources.cfg
-
-# 2017-05-30 plone.app.widgets 2.1.1 does not suffice
-# TODO get rid of auto-checkout when new release has happened 
-extensions = mr.developer
-auto-checkout = plone.app.widgets
 
 [versions]
-Products.Archetypes = 
+Products.Archetypes =
 
 [test]
 recipe = zc.recipe.testrunner


Repository: Products.Archetypes


Branch: refs/heads/master
Date: 2018-01-28T21:29:17+01:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/Products.Archetypes/commit/88f5fa488582b4815cc1a3d1a36c1e3cbe4c73fa

try more recent zc.buildout 2.9.5

Files changed:
M .travis.yml

diff --git a/.travis.yml b/.travis.yml
index dc42630b..7184ea77 100644
--- a/.travis.yml
+++ b/.travis.yml
@@ -8,7 +8,7 @@ cache:
 before_install:
   - mkdir -p $HOME/buildout-cache/{eggs,downloads}
   - virtualenv .
-  - bin/python bootstrap.py --setuptools-version=33.1.1 --buildout-version=2.8.0  #from https://github.com/plone/buildout.coredev/blob/5.1/requirements.txt 2017-05-30 11:57
+  - bin/python bootstrap.py --setuptools-version=33.1.1 --buildout-version=2.9.5  # from https://github.com/plone/buildout.coredev/blob/5.1/requirements.txt 2018-01-28 21:28
 install:
   - bin/buildout -Nvt 5 -c travis.cfg
 script:


Repository: Products.Archetypes


Branch: refs/heads/master
Date: 2018-01-28T21:36:16+01:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/Products.Archetypes/commit/b035650ca9a974b21ebefba96b85ac7222e1aed0

Latest setuptools and zc.buildout to get Travis running. Maybe.

Files changed:
M .travis.yml
M buildout.cfg

diff --git a/.travis.yml b/.travis.yml
index 7184ea77..d75865d3 100644
--- a/.travis.yml
+++ b/.travis.yml
@@ -8,7 +8,8 @@ cache:
 before_install:
   - mkdir -p $HOME/buildout-cache/{eggs,downloads}
   - virtualenv .
-  - bin/python bootstrap.py --setuptools-version=33.1.1 --buildout-version=2.9.5  # from https://github.com/plone/buildout.coredev/blob/5.1/requirements.txt 2018-01-28 21:28
+# Keep in sync with buildout.cfg:
+  - bin/python bootstrap.py --setuptools-version=38.2.4 --buildout-version=2.11.0
 install:
   - bin/buildout -Nvt 5 -c travis.cfg
 script:
diff --git a/buildout.cfg b/buildout.cfg
index b48d77c6..dd287623 100644
--- a/buildout.cfg
+++ b/buildout.cfg
@@ -6,6 +6,9 @@ extends = http://dist.plone.org/release/5.1-latest/versions.cfg
 
 [versions]
 Products.Archetypes =
+# Keep in sync with .travis.yml:
+setuptools = 38.2.4
+zc.buildout = 2.11.0
 
 [test]
 recipe = zc.recipe.testrunner


Repository: Products.Archetypes


Branch: refs/heads/master
Date: 2018-01-29T10:04:07+01:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/Products.Archetypes/commit/2f8e765fef4bca875d6c65e5ae52d328614366c8

Merge pull request #103 from plone/no-qi

 Removed CMFQuickInstaller dependency

Files changed:
M .travis.yml
M CHANGES.rst
M Products/Archetypes/Extensions/migrations.py
M Products/Archetypes/Extensions/utils.py
M Products/Archetypes/configure.zcml
M buildout.cfg
M setup.py

diff --git a/.travis.yml b/.travis.yml
index dc42630b..d75865d3 100644
--- a/.travis.yml
+++ b/.travis.yml
@@ -8,7 +8,8 @@ cache:
 before_install:
   - mkdir -p $HOME/buildout-cache/{eggs,downloads}
   - virtualenv .
-  - bin/python bootstrap.py --setuptools-version=33.1.1 --buildout-version=2.8.0  #from https://github.com/plone/buildout.coredev/blob/5.1/requirements.txt 2017-05-30 11:57
+# Keep in sync with buildout.cfg:
+  - bin/python bootstrap.py --setuptools-version=38.2.4 --buildout-version=2.11.0
 install:
   - bin/buildout -Nvt 5 -c travis.cfg
 script:
diff --git a/CHANGES.rst b/CHANGES.rst
index 31c9dbda..6f38181e 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -10,7 +10,9 @@ Breaking changes:
 
 New features:
 
-- *add item here*
+- Removed CMFQuickInstaller dependency.
+  This was only used in ancient migration code.
+  [maurits]
 
 Bug fixes:
 
diff --git a/Products/Archetypes/Extensions/migrations.py b/Products/Archetypes/Extensions/migrations.py
index 942dba13..66d39a7b 100644
--- a/Products/Archetypes/Extensions/migrations.py
+++ b/Products/Archetypes/Extensions/migrations.py
@@ -31,16 +31,19 @@ def write(self, s):
 def reinstallArchetypes(portal, out):
     """let's quickinstaller (re)install Archetypes and it's dependencies
     """
-    qi = getToolByName(portal, 'portal_quickinstaller')
+    # Import here so it does not break when you manage to
+    # get a too old CMFPlone with a too new Archetypes.
+    from Products.CMFPlone.utils import get_installer
+    qi = get_installer(portal)
     products = ('MimetypesRegistry', 'PortalTransforms', 'Archetypes', )
     print >>out, 'Reinstalling Archetypes and it\'s dependencies'
     for product in products:
-        if qi.isProductInstalled(product):
-            qi.reinstallProducts([product])
-            print >>out, '... reinstalling %s' % product
-        else:
-            qi.installProducts([product])
-            print >>out, '... installing %s' % product
+        full_product = 'Products.{0}'.format(product)
+        if qi.is_product_installed(full_product):
+            qi.uninstall_product(full_product)
+            print >>out, '... uninstalling %s' % full_product
+        qi.install_product(full_product)
+        print >>out, '... installing %s' % full_product
     print >>out, 'Done\n'
 
 
diff --git a/Products/Archetypes/Extensions/utils.py b/Products/Archetypes/Extensions/utils.py
index c969f324..007f89df 100644
--- a/Products/Archetypes/Extensions/utils.py
+++ b/Products/Archetypes/Extensions/utils.py
@@ -306,19 +306,22 @@ def setupEnvironment(self, out, types,
                      install_deps=1):
 
     if install_deps:
-        qi = getToolByName(self, 'portal_quickinstaller', None)
         if require_dependencies:
-            if not qi.isProductInstalled('CMFFormController'):
-                qi.installProduct('CMFFormController', locked=1)
+            # Import here so it does not break when you manage to
+            # get a too old CMFPlone with a too new Archetypes.
+            from Products.CMFPlone.utils import get_installer
+            qi = get_installer(self)
+            if not qi.is_product_installed('Products.CMFFormController'):
+                qi.install_product('Products.CMFFormController', locked=1)
                 print >>out, 'Installing CMFFormController'
-            if not qi.isProductInstalled('MimetypesRegistry'):
-                qi.installProduct('MimetypesRegistry')
+            if not qi.is_product_installed('Products.MimetypesRegistry'):
+                qi.install_product('Products.MimetypesRegistry')
                 print >>out, 'Installing MimetypesRegistry'
-            if not qi.isProductInstalled('PortalTransforms'):
-                qi.installProduct('PortalTransforms')
+            if not qi.is_product_installed('Products.PortalTransforms'):
+                qi.install_product('Products.PortalTransforms')
                 print >>out, 'Installing PortalTransforms'
-            if not qi.isProductInstalled('Archetypes'):
-                qi.installProduct('Archetypes')
+            if not qi.is_product_installed('Archetypes'):
+                qi.install_product('Products.Archetypes')
                 print >>out, 'Installing Archetypes'
 
     if product_skins_dir:
diff --git a/Products/Archetypes/configure.zcml b/Products/Archetypes/configure.zcml
index 2be78b9d..4efd0742 100644
--- a/Products/Archetypes/configure.zcml
+++ b/Products/Archetypes/configure.zcml
@@ -13,7 +13,6 @@
   <include package="plone.uuid" />
 
   <include package="Products.CMFFormController" />
-  <include package="Products.CMFQuickInstallerTool" />
   <include package="Products.MimetypesRegistry" />
   <include package="Products.PortalTransforms" />
   <include package="Products.statusmessages" />
diff --git a/buildout.cfg b/buildout.cfg
index 79fbe418..dd287623 100644
--- a/buildout.cfg
+++ b/buildout.cfg
@@ -1,16 +1,14 @@
 [buildout]
+index = https://pypi.python.org/simple/
 develop = .
 parts = test
 extends = http://dist.plone.org/release/5.1-latest/versions.cfg
-          https://raw.githubusercontent.com/plone/buildout.coredev/5.1/sources.cfg
-
-# 2017-05-30 plone.app.widgets 2.1.1 does not suffice
-# TODO get rid of auto-checkout when new release has happened 
-extensions = mr.developer
-auto-checkout = plone.app.widgets
 
 [versions]
-Products.Archetypes = 
+Products.Archetypes =
+# Keep in sync with .travis.yml:
+setuptools = 38.2.4
+zc.buildout = 2.11.0
 
 [test]
 recipe = zc.recipe.testrunner
diff --git a/setup.py b/setup.py
index 55d61311..4e84ba39 100644
--- a/setup.py
+++ b/setup.py
@@ -53,7 +53,6 @@
           'zope.viewlet',
           'Products.CMFCore',
           'Products.CMFFormController',
-          'Products.CMFQuickInstallerTool',
           'Products.DCWorkflow',
           'Products.GenericSetup>=1.8.3',
           'Products.MimetypesRegistry>=2.0.3',


